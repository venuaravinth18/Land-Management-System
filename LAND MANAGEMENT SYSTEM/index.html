<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced FarmLand Manager</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #8BC34A;
            --dark: #2E7D32;
            --light: #DCEDC8;
            --danger: #f44336;
            --warning: #ff9800;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            margin: 0 0.2rem;
            border-radius: 4px;
            transition: background 0.3s;
        }

        nav ul li a:hover, nav ul li a.active {
            background: var(--dark);
        }

        main {
            padding: 2rem;
        }

        .view {
            display: none;
        }
        .view.active {
            display: block;
        }

        /* Dashboard Styles */
        .overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: var(--dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card h3 i {
            font-size: 1.2rem;
        }

        .card p {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .alert {
            background: #fff3e0;
            border-left: 4px solid var(--warning);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 4px 4px 0;
        }

        .alert.danger {
            background: #ffebee;
            border-left-color: var(--danger);
        }

        /* Map Styles */
        #map {
            height: 500px;
            background: var(--light);
            border-radius: 8px;
            margin: 1rem 0;
            z-index: 1;
        }

        /* Form Styles */
        .form-container {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, select, textarea {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        button, .btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:hover, .btn:hover {
            background: var(--dark);
            transform: translateY(-2px);
        }

        button.danger {
            background: var(--danger);
        }

        button.warning {
            background: var(--warning);
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-table th, .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: var(--light);
            font-weight: 600;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background: #f5f5f5;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge.primary {
            background: #e8f5e9;
            color: var(--dark);
        }

        .badge.warning {
            background: #fff8e1;
            color: #ff8f00;
        }

        .badge.danger {
            background: #ffebee;
            color: var(--danger);
        }

        /* Chart Container */
        .chart-container {
            height: 300px;
            margin: 1rem 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .overview {
                grid-template-columns: 1fr;
            }
        }

        /* Icons */
        .icon {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Advanced FarmLand Manager</h1>
        <nav>
            <ul>
                <li><a href="#" class="nav-link active" data-view="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link" data-view="fields">Fields</a></li>
                <li><a href="#" class="nav-link" data-view="crops">Crops</a></li>
                <li><a href="#" class="nav-link" data-view="soil">Soil Health</a></li>
                <li><a href="#" class="nav-link" data-view="reports">Reports</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <!-- Dashboard View -->
        <div id="dashboardView" class="view active">
            <div class="overview">
                <div class="card">
                    <h3><span class="icon">ðŸŒ¾</span> Total Fields</h3>
                    <p id="fieldCount">0</p>
                </div>
                <div class="card">
                    <h3><span class="icon">ðŸŒ±</span> Active Crops</h3>
                    <p id="cropCount">0</p>
                </div>
                <div class="card">
                    <h3><span class="icon">ðŸ§ª</span> Soil Tests Needed</h3>
                    <p id="soilAlertCount">0</p>
                </div>
                <div class="card">
                    <h3><span class="icon">ðŸ’°</span> Estimated Revenue</h3>
                    <p id="revenueEstimate">$0</p>
                </div>
            </div>

            <div class="alert warning">
                <strong>3 fields</strong> need soil testing this month
            </div>

            <div class="alert danger">
                <strong>2 crops</strong> are approaching harvest time
            </div>

            <h2>Field Map</h2>
            <div id="map"></div>

            <h2>Recent Activity</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Activity</th>
                        <th>Field</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="activityLog">
                    <!-- Filled by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Fields Management View -->
        <div id="fieldsView" class="view">
            <h1>Field Management</h1>
            
            <div class="form-container">
                <h2>Add New Field</h2>
                <form id="fieldForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fieldName">Field Name</label>
                            <input type="text" id="fieldName" required>
                        </div>
                        <div class="form-group">
                            <label for="fieldSize">Size (acres)</label>
                            <input type="number" id="fieldSize" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fieldType">Soil Type</label>
                            <select id="fieldType" required>
                                <option value="">Select Soil Type</option>
                                <option value="clay">Clay</option>
                                <option value="sandy">Sandy</option>
                                <option value="loam">Loam</option>
                                <option value="silt">Silt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fieldLocation">Location Coordinates</label>
                            <input type="text" id="fieldLocation" placeholder="Click on map to set">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fieldNotes">Notes</label>
                            <textarea id="fieldNotes" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit">Save Field</button>
                </form>
            </div>

            <h2>Your Fields</h2>
            <table class="data-table" id="fieldsTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Size</th>
                        <th>Soil Type</th>
                        <th>Current Crop</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Filled by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Crops Management View -->
        <div id="cropsView" class="view">
            <h1>Crop Management</h1>
            
            <div class="form-container">
                <h2>Plant New Crop</h2>
                <form id="cropForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cropField">Field</label>
                            <select id="cropField" required>
                                <option value="">Select Field</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cropType">Crop Type</label>
                            <select id="cropType" required>
                                <option value="">Select Crop</option>
                                <option value="wheat">Wheat</option>
                                <option value="corn">Corn</option>
                                <option value="soybean">Soybean</option>
                                <option value="rice">Rice</option>
                                <option value="vegetables">Vegetables</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="plantingDate">Planting Date</label>
                            <input type="date" id="plantingDate" required>
                        </div>
                        <div class="form-group">
                            <label for="harvestDate">Expected Harvest Date</label>
                            <input type="date" id="harvestDate" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cropVariety">Variety</label>
                            <input type="text" id="cropVariety">
                        </div>
                        <div class="form-group">
                            <label for="cropDensity">Planting Density (plants/acre)</label>
                            <input type="number" id="cropDensity">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cropNotes">Notes</label>
                            <textarea id="cropNotes" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit">Save Crop</button>
                </form>
            </div>

            <h2>Current Crops</h2>
            <table class="data-table" id="cropsTable">
                <thead>
                    <tr>
                        <th>Crop</th>
                        <th>Field</th>
                        <th>Planted</th>
                        <th>Harvest Due</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Filled by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Soil Health View -->
        <div id="soilView" class="view">
            <h1>Soil Health Monitoring</h1>
            
            <div class="form-container">
                <h2>Record Soil Test</h2>
                <form id="soilTestForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="soilField">Field</label>
                            <select id="soilField" required>
                                <option value="">Select Field</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="testDate">Test Date</label>
                            <input type="date" id="testDate" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="phLevel">pH Level</label>
                            <input type="number" id="phLevel" step="0.1" min="0" max="14" required>
                        </div>
                        <div class="form-group">
                            <label for="organicMatter">Organic Matter (%)</label>
                            <input type="number" id="organicMatter" step="0.1" min="0" max="100">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nitrogen">Nitrogen (ppm)</label>
                            <input type="number" id="nitrogen">
                        </div>
                        <div class="form-group">
                            <label for="phosphorus">Phosphorus (ppm)</label>
                            <input type="number" id="phosphorus">
                        </div>
                        <div class="form-group">
                            <label for="potassium">Potassium (ppm)</label>
                            <input type="number" id="potassium">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="soilNotes">Recommendations</label>
                            <textarea id="soilNotes" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit">Save Soil Test</button>
                </form>
            </div>

            <h2>Soil Test History</h2>
            <table class="data-table" id="soilTestsTable">
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Test Date</th>
                        <th>pH</th>
                        <th>N-P-K</th>
                        <th>Organic Matter</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Filled by JavaScript -->
                </tbody>
            </table>
            
            <h2>Soil Health Dashboard</h2>
            <div class="chart-container">
                <canvas id="soilHealthChart"></canvas>
            </div>
        </div>

        <!-- Reports View -->
        <div id="reportsView" class="view">
            <h1>Farm Reports</h1>
            
            <div class="card">
                <h2>Generate Report</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportType">Report Type</label>
                        <select id="reportType">
                            <option value="crop_performance">Crop Performance</option>
                            <option value="soil_trends">Soil Trends</option>
                            <option value="field_utilization">Field Utilization</option>
                            <option value="harvest_forecast">Harvest Forecast</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportPeriod">Time Period</label>
                        <select id="reportPeriod">
                            <option value="last_month">Last Month</option>
                            <option value="last_quarter">Last Quarter</option>
                            <option value="last_year">Last Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="form-group" id="customDateRange" style="display: none;">
                        <label>Custom Range</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="date" id="startDate">
                            <span>to</span>
                            <input type="date" id="endDate">
                        </div>
                    </div>
                </div>
                <button id="generateReport">Generate Report</button>
            </div>
            
            <div id="reportResults" style="margin-top: 2rem;">
                <!-- Report content will be inserted here -->
            </div>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Main Application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the application
            initApp();
        });

        // Global variables
        let map;
        let soilChart;
        let fields = [];
        let crops = [];
        let soilTests = [];
        let activities = [];

        // Initialize the application
        function initApp() {
            // Load data from localStorage
            loadData();
            
            // Initialize map
            initMap();
            
            // Setup navigation
            setupNavigation();
            
            // Setup forms
            setupForms();
            
            // Initialize charts
            initCharts();
            
            // Update UI
            updateUI();
        }

        // Load data from localStorage
        function loadData() {
            fields = JSON.parse(localStorage.getItem('fields')) || [];
            crops = JSON.parse(localStorage.getItem('crops')) || [];
            soilTests = JSON.parse(localStorage.getItem('soilTests')) || [];
            activities = JSON.parse(localStorage.getItem('activities')) || [];
            
            // Add some sample data if empty
            if (fields.length === 0) {
                fields = [
                    {
                        id: 1,
                        name: "North Field",
                        size: 10.5,
                        type: "loam",
                        location: "40.7128,-74.0060",
                        notes: "Main production field",
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: "South Field",
                        size: 8.2,
                        type: "clay",
                        location: "40.7100,-74.0080",
                        notes: "Needs drainage improvement",
                        createdAt: new Date().toISOString()
                    }
                ];
                localStorage.setItem('fields', JSON.stringify(fields));
            }
            
            if (crops.length === 0) {
                crops = [
                    {
                        id: 1,
                        fieldId: 1,
                        type: "corn",
                        variety: "Golden Harvest",
                        plantingDate: "2023-05-15",
                        harvestDate: "2023-09-30",
                        density: 32000,
                        notes: "Planted after spring rains",
                        status: "growing",
                        createdAt: new Date().toISOString()
                    }
                ];
                localStorage.setItem('crops', JSON.stringify(crops));
            }
            
            if (soilTests.length === 0) {
                soilTests = [
                    {
                        id: 1,
                        fieldId: 1,
                        date: "2023-04-10",
                        ph: 6.5,
                        organicMatter: 3.2,
                        nitrogen: 25,
                        phosphorus: 15,
                        potassium: 120,
                        notes: "Good balance, add phosphorus",
                        createdAt: new Date().toISOString()
                    }
                ];
                localStorage.setItem('soilTests', JSON.stringify(soilTests));
            }
            
            if (activities.length === 0) {
                activities = [
                    {
                        id: 1,
                        type: "planting",
                        fieldId: 1,
                        cropId: 1,
                        date: "2023-05-15",
                        notes: "Planted corn in North Field",
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        type: "soil_test",
                        fieldId: 1,
                        date: "2023-04-10",
                        notes: "Conducted spring soil test",
                        createdAt: new Date().toISOString()
                    }
                ];
                localStorage.setItem('activities', JSON.stringify(activities));
            }
        }

        // Initialize the map
        function initMap() {
            map = L.map('map').setView([40.7128, -74.0060], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Add fields to map
            fields.forEach(field => {
                if (field.location) {
                    const [lat, lng] = field.location.split(',').map(Number);
                    L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup(`<b>${field.name}</b><br>${field.size} acres<br>Soil: ${field.type}`)
                        .openPopup();
                }
            });
            
            // Handle map clicks for new fields
            map.on('click', function(e) {
                if (document.getElementById('fieldsView').classList.contains('active')) {
                    document.getElementById('fieldLocation').value = `${e.latlng.lat.toFixed(4)},${e.latlng.lng.toFixed(4)}`;
                    
                    // Move marker
                    if (window.fieldMarker) {
                        map.removeLayer(window.fieldMarker);
                    }
                    window.fieldMarker = L.marker(e.latlng).addTo(map)
                        .bindPopup("New Field Location")
                        .openPopup();
                }
            });
        }

        // Setup navigation
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update active nav
                    document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show correct view
                    document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
                    document.getElementById(`${this.dataset.view}View`).classList.add('active');
                    
                    // Update the view
                    updateUI();
                });
            });
        }

        // Setup forms
        function setupForms() {
            // Field form
            document.getElementById('fieldForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveField();
            });
            
            // Crop form
            document.getElementById('cropForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCrop();
            });
            
            // Soil test form
            document.getElementById('soilTestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSoilTest();
            });
            
            // Report form
            document.getElementById('reportType').addEventListener('change', function() {
                updateReportForm();
            });
            
            document.getElementById('reportPeriod').addEventListener('change', function() {
                updateReportForm();
            });
            
            document.getElementById('generateReport').addEventListener('click', function() {
                generateReport();
            });
        }

        // Initialize charts
        function initCharts() {
            const ctx = document.getElementById('soilHealthChart').getContext('2d');
            soilChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'pH Level',
                            data: [],
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Organic Matter (%)',
                            data: [],
                            backgroundColor: 'rgba(153, 102, 255, 0.6)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update UI based on current view
        function updateUI() {
            const activeView = document.querySelector('.view.active').id;
            
            if (activeView === 'dashboardView') {
                updateDashboard();
            } else if (activeView === 'fieldsView') {
                updateFieldsView();
            } else if (activeView === 'cropsView') {
                updateCropsView();
            } else if (activeView === 'soilView') {
                updateSoilView();
            } else if (activeView === 'reportsView') {
                updateReportsView();
            }
        }

        // Update dashboard
        function updateDashboard() {
            document.getElementById('fieldCount').textContent = fields.length;
            document.getElementById('cropCount').textContent = crops.filter(c => c.status === 'growing').length;
            
            // Calculate soil tests needed (fields tested more than 6 months ago)
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            
            const fieldsNeedingTests = fields.filter(field => {
                const lastTest = soilTests
                    .filter(test => test.fieldId === field.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                return !lastTest || new Date(lastTest.date) < sixMonthsAgo;
            });
            
            document.getElementById('soilAlertCount').textContent = fieldsNeedingTests.length;
            
            // Calculate estimated revenue
            const revenue = crops.reduce((sum, crop) => {
                // Very simple estimation - would be replaced with real calculations
                const field = fields.find(f => f.id === crop.fieldId);
                if (!field) return sum;
                
                let valuePerAcre = 0;
                switch(crop.type) {
                    case 'corn': valuePerAcre = 800; break;
                    case 'wheat': valuePerAcre = 500; break;
                    case 'soybean': valuePerAcre = 600; break;
                    case 'rice': valuePerAcre = 700; break;
                    case 'vegetables': valuePerAcre = 1200; break;
                }
                
                return sum + (field.size * valuePerAcre * 0.8); // 80% of potential
            }, 0);
            
            document.getElementById('revenueEstimate').textContent = `$${revenue.toLocaleString()}`;
            
            // Update activity log
            const activityLog = document.getElementById('activityLog');
            activityLog.innerHTML = '';
            
            activities
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5)
                .forEach(activity => {
                    const row = document.createElement('tr');
                    
                    let activityText = '';
                    let fieldName = fields.find(f => f.id === activity.fieldId)?.name || 'Unknown Field';
                    
                    switch(activity.type) {
                        case 'planting':
                            const crop = crops.find(c => c.id === activity.cropId);
                            activityText = `Planted ${crop?.type || 'crop'} in ${fieldName}`;
                            break;
                        case 'harvest':
                            activityText = `Harvested ${fieldName}`;
                            break;
                        case 'soil_test':
                            activityText = `Conducted soil test in ${fieldName}`;
                            break;
                        case 'fertilization':
                            activityText = `Applied fertilizer to ${fieldName}`;
                            break;
                        default:
                            activityText = activity.notes || 'Activity recorded';
                    }
                    
                    row.innerHTML = `
                        <td>${formatDate(activity.date)}</td>
                        <td>${activityText}</td>
                        <td>${fieldName}</td>
                        <td><span class="badge primary">Completed</span></td>
                    `;
                    
                    activityLog.appendChild(row);
                });
        }

        // Update fields view
        function updateFieldsView() {
            const fieldsTable = document.getElementById('fieldsTable').querySelector('tbody');
            fieldsTable.innerHTML = '';
            
            fields.forEach(field => {
                const row = document.createElement('tr');
                
                // Find current crop for this field
                const currentCrop = crops.find(c => c.fieldId === field.id && c.status === 'growing');
                
                row.innerHTML = `
                    <td>${field.name}</td>
                    <td>${field.size} acres</td>
                    <td>${field.type}</td>
                    <td>${currentCrop ? `${currentCrop.type} (${formatDate(currentCrop.plantingDate)})` : 'None'}</td>
                    <td>
                        <span class="badge ${currentCrop ? 'primary' : 'warning'}">
                            ${currentCrop ? 'Planted' : 'Available'}
                        </span>
                    </td>
                    <td>
                        <button onclick="editField(${field.id})">Edit</button>
                        <button class="danger" onclick="deleteField(${field.id})">Delete</button>
                    </td>
                `;
                
                fieldsTable.appendChild(row);
            });
        }

        // Update crops view
        function updateCropsView() {
            // Update field dropdown
            const fieldSelect = document.getElementById('cropField');
            fieldSelect.innerHTML = '<option value="">Select Field</option>';
            
            fields.filter(field => {
                // Only show fields without active crops
                return !crops.some(c => c.fieldId === field.id && c.status === 'growing');
            }).forEach(field => {
                const option = document.createElement('option');
                option.value = field.id;
                option.textContent = `${field.name} (${field.size} acres)`;
                fieldSelect.appendChild(option);
            });
            
            // Update crops table
            const cropsTable = document.getElementById('cropsTable').querySelector('tbody');
            cropsTable.innerHTML = '';
            
            crops.forEach(crop => {
                const row = document.createElement('tr');
                const field = fields.find(f => f.id === crop.fieldId);
                const daysToHarvest = Math.floor((new Date(crop.harvestDate) - new Date()) / (1000 * 60 * 60 * 24));
                
                let statusClass = 'primary';
                let statusText = 'Growing';
                
                if (daysToHarvest < 0) {
                    statusClass = 'danger';
                    statusText = 'Overdue';
                } else if (daysToHarvest < 14) {
                    statusClass = 'warning';
                    statusText = 'Ready Soon';
                }
                
                row.innerHTML = `
                    <td>${crop.type} ${crop.variety ? `(${crop.variety})` : ''}</td>
                    <td>${field?.name || 'Unknown Field'}</td>
                    <td>${formatDate(crop.plantingDate)}</td>
                    <td>${formatDate(crop.harvestDate)} (${daysToHarvest > 0 ? `${daysToHarvest} days` : 'past due'})</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <button onclick="editCrop(${crop.id})">Edit</button>
                        <button class="danger" onclick="deleteCrop(${crop.id})">Delete</button>
                    </td>
                `;
                
                cropsTable.appendChild(row);
            });
        }

        // Update soil view
        function updateSoilView() {
            // Update field dropdown
            const fieldSelect = document.getElementById('soilField');
            fieldSelect.innerHTML = '<option value="">Select Field</option>';
            
            fields.forEach(field => {
                const option = document.createElement('option');
                option.value = field.id;
                option.textContent = `${field.name} (${field.type} soil)`;
                fieldSelect.appendChild(option);
            });
            
            // Update soil tests table
            const soilTestsTable = document.getElementById('soilTestsTable').querySelector('tbody');
            soilTestsTable.innerHTML = '';
            
            soilTests.forEach(test => {
                const row = document.createElement('tr');
                const field = fields.find(f => f.id === test.fieldId);
                
                row.innerHTML = `
                    <td>${field?.name || 'Unknown Field'}</td>
                    <td>${formatDate(test.date)}</td>
                    <td>${test.ph}</td>
                    <td>${test.nitrogen}-${test.phosphorus}-${test.potassium}</td>
                    <td>${test.organicMatter}%</td>
                    <td>
                        <button onclick="viewSoilTest(${test.id})">View</button>
                        <button class="danger" onclick="deleteSoilTest(${test.id})">Delete</button>
                    </td>
                `;
                
                soilTestsTable.appendChild(row);
            });
            
            // Update soil health chart
            updateSoilChart();
        }

        // Update soil health chart
        function updateSoilChart() {
            const fieldIds = [...new Set(soilTests.map(test => test.fieldId))];
            
            soilChart.data.labels = fieldIds.map(id => {
                const field = fields.find(f => f.id === id);
                return field?.name || `Field ${id}`;
            });
            
            soilChart.data.datasets[0].data = fieldIds.map(id => {
                const lastTest = soilTests
                    .filter(test => test.fieldId === id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                return lastTest?.ph || 0;
            });
            
            soilChart.data.datasets[1].data = fieldIds.map(id => {
                const lastTest = soilTests
                    .filter(test => test.fieldId === id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                return lastTest?.organicMatter || 0;
            });
            
            soilChart.update();
        }

        // Update reports view
        function updateReportsView() {
            // Nothing needed here yet
        }

        // Update report form based on selections
        function updateReportForm() {
            const reportType = document.getElementById('reportType').value;
            const reportPeriod = document.getElementById('reportPeriod').value;
            
            // Show/hide custom date range
            if (reportPeriod === 'custom') {
                document.getElementById('customDateRange').style.display = 'block';
            } else {
                document.getElementById('customDateRange').style.display = 'none';
            }
        }

        // Generate report
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportPeriod = document.getElementById('reportPeriod').value;
            
            let startDate, endDate;
            
            if (reportPeriod === 'custom') {
                startDate = new Date(document.getElementById('startDate').value);
                endDate = new Date(document.getElementById('endDate').value);
            } else {
                endDate = new Date();
                
                switch(reportPeriod) {
                    case 'last_month':
                        startDate = new Date();
                        startDate.setMonth(startDate.getMonth() - 1);
                        break;
                    case 'last_quarter':
                        startDate = new Date();
                        startDate.setMonth(startDate.getMonth() - 3);
                        break;
                    case 'last_year':
                        startDate = new Date();
                        startDate.setFullYear(startDate.getFullYear() - 1);
                        break;
                }
            }
            
            const reportResults = document.getElementById('reportResults');
            reportResults.innerHTML = '<h2>Generating report...</h2>';
            
            // Simulate report generation
            setTimeout(() => {
                let reportHTML = `
                    <div class="card">
                        <h2>${getReportTitle(reportType)} Report</h2>
                        <p>Period: ${formatDate(startDate)} to ${formatDate(endDate)}</p>
                `;
                
                switch(reportType) {
                    case 'crop_performance':
                        reportHTML += generateCropPerformanceReport(startDate, endDate);
                        break;
                    case 'soil_trends':
                        reportHTML += generateSoilTrendsReport(startDate, endDate);
                        break;
                    case 'field_utilization':
                        reportHTML += generateFieldUtilizationReport(startDate, endDate);
                        break;
                    case 'harvest_forecast':
                        reportHTML += generateHarvestForecastReport(startDate, endDate);
                        break;
                }
                
                reportHTML += `</div>`;
                reportResults.innerHTML = reportHTML;
            }, 1000);
        }

        // Generate crop performance report
        function generateCropPerformanceReport(startDate, endDate) {
            const relevantCrops = crops.filter(crop => {
                const plantingDate = new Date(crop.plantingDate);
                return plantingDate >= startDate && plantingDate <= endDate;
            });
            
            if (relevantCrops.length === 0) {
                return '<p>No crops planted in this period</p>';
            }
            
            let html = `
                <h3>Crop Performance Summary</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Crop</th>
                            <th>Field</th>
                            <th>Planted</th>
                            <th>Harvested</th>
                            <th>Status</th>
                            <th>Yield</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            relevantCrops.forEach(crop => {
                const field = fields.find(f => f.id === crop.fieldId);
                const yieldEstimate = (field?.size || 0) * getCropYieldPerAcre(crop.type);
                
                html += `
                    <tr>
                        <td>${crop.type}</td>
                        <td>${field?.name || 'Unknown'}</td>
                        <td>${formatDate(crop.plantingDate)}</td>
                        <td>${crop.status === 'harvested' ? formatDate(crop.harvestDate) : 'Pending'}</td>
                        <td>${crop.status}</td>
                        <td>${yieldEstimate.toLocaleString()} kg</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            return html;
        }

        // Generate soil trends report
        function generateSoilTrendsReport(startDate, endDate) {
            const relevantTests = soilTests.filter(test => {
                const testDate = new Date(test.date);
                return testDate >= startDate && testDate <= endDate;
            });
            
            if (relevantTests.length === 0) {
                return '<p>No soil tests conducted in this period</p>';
            }
            
            let html = `
                <h3>Soil Health Trends</h3>
                <div class="chart-container">
                    <canvas id="reportSoilChart"></canvas>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Field</th>
                            <th>Test Date</th>
                            <th>pH</th>
                            <th>N-P-K</th>
                            <th>Organic Matter</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            relevantTests.forEach(test => {
                const field = fields.find(f => f.id === test.fieldId);
                
                html += `
                    <tr>
                        <td>${field?.name || 'Unknown'}</td>
                        <td>${formatDate(test.date)}</td>
                        <td>${test.ph}</td>
                        <td>${test.nitrogen}-${test.phosphorus}-${test.potassium}</td>
                        <td>${test.organicMatter}%</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            
            // Initialize chart after HTML is inserted
            setTimeout(() => {
                const ctx = document.getElementById('reportSoilChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: relevantTests.map(test => {
                            const field = fields.find(f => f.id === test.fieldId);
                            return `${field?.name || 'Field'} - ${formatDate(test.date)}`;
                        }),
                        datasets: [
                            {
                                label: 'pH Level',
                                data: relevantTests.map(test => test.ph),
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1
                            },
                            {
                                label: 'Organic Matter (%)',
                                data: relevantTests.map(test => test.organicMatter),
                                borderColor: 'rgba(153, 102, 255, 1)',
                                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            }, 100);
            
            return html;
        }

        // Generate field utilization report
        function generateFieldUtilizationReport(startDate, endDate) {
            let html = `
                <h3>Field Utilization</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Field</th>
                            <th>Size (acres)</th>
                            <th>Days Planted</th>
                            <th>Utilization Rate</th>
                            <th>Current Crop</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            fields.forEach(field => {
                const fieldCrops = crops.filter(c => c.fieldId === field.id);
                const daysInPeriod = (endDate - startDate) / (1000 * 60 * 60 * 24);
                let daysPlanted = 0;
                
                fieldCrops.forEach(crop => {
                    const plantingDate = new Date(crop.plantingDate);
                    const harvestDate = crop.status === 'harvested' ? new Date(crop.harvestDate) : endDate;
                    
                    // Only count days within our report period
                    const effectivePlanting = plantingDate < startDate ? startDate : plantingDate;
                    const effectiveHarvest = harvestDate > endDate ? endDate : harvestDate;
                    
                    daysPlanted += (effectiveHarvest - effectivePlanting) / (1000 * 60 * 60 * 24);
                });
                
                const utilization = (daysPlanted / daysInPeriod) * 100;
                const currentCrop = crops.find(c => c.fieldId === field.id && c.status === 'growing');
                
                html += `
                    <tr>
                        <td>${field.name}</td>
                        <td>${field.size}</td>
                        <td>${Math.round(daysPlanted)}</td>
                        <td>${utilization.toFixed(1)}%</td>
                        <td>${currentCrop ? currentCrop.type : 'None'}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            return html;
        }

        // Generate harvest forecast report
        function generateHarvestForecastReport(startDate, endDate) {
            const upcomingHarvests = crops.filter(crop => {
                if (crop.status !== 'growing') return false;
                
                const harvestDate = new Date(crop.harvestDate);
                return harvestDate >= startDate && harvestDate <= endDate;
            });
            
            if (upcomingHarvests.length === 0) {
                return '<p>No harvests scheduled for this period</p>';
            }
            
            let html = `
                <h3>Upcoming Harvests</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Crop</th>
                            <th>Field</th>
                            <th>Planted</th>
                            <th>Harvest Due</th>
                            <th>Days Remaining</th>
                            <th>Estimated Yield</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            upcomingHarvests.forEach(crop => {
                const field = fields.find(f => f.id === crop.fieldId);
                const daysRemaining = Math.floor((new Date(crop.harvestDate) - new Date()) / (1000 * 60 * 60 * 24));
                const yieldEstimate = (field?.size || 0) * getCropYieldPerAcre(crop.type);
                
                html += `
                    <tr>
                        <td>${crop.type}</td>
                        <td>${field?.name || 'Unknown'}</td>
                        <td>${formatDate(crop.plantingDate)}</td>
                        <td>${formatDate(crop.harvestDate)}</td>
                        <td>${daysRemaining}</td>
                        <td>${yieldEstimate.toLocaleString()} kg</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            return html;
        }

        // Get report title
        function getReportTitle(reportType) {
            switch(reportType) {
                case 'crop_performance': return 'Crop Performance';
                case 'soil_trends': return 'Soil Trends';
                case 'field_utilization': return 'Field Utilization';
                case 'harvest_forecast': return 'Harvest Forecast';
                default: return '';
            }
        }

        // Get estimated yield per acre for a crop type
        function getCropYieldPerAcre(cropType) {
            switch(cropType) {
                case 'corn': return 8000;
                case 'wheat': return 5000;
                case 'soybean': return 3000;
                case 'rice': return 7000;
                case 'vegetables': return 10000;
                default: return 0;
            }
        }

        // Save a new field
        function saveField() {
            const name = document.getElementById('fieldName').value;
            const size = parseFloat(document.getElementById('fieldSize').value);
            const type = document.getElementById('fieldType').value;
            const location = document.getElementById('fieldLocation').value;
            const notes = document.getElementById('fieldNotes').value;
            
            const newField = {
                id: fields.length > 0 ? Math.max(...fields.map(f => f.id)) + 1 : 1,
                name,
                size,
                type,
                location,
                notes,
                createdAt: new Date().toISOString()
            };
            
            fields.push(newField);
            localStorage.setItem('fields', JSON.stringify(fields));
            
            // Add to map
            if (location) {
                const [lat, lng] = location.split(',').map(Number);
                L.marker([lat, lng])
                    .addTo(map)
                    .bindPopup(`<b>${name}</b><br>${size} acres<br>Soil: ${type}`)
                    .openPopup();
            }
            
            // Log activity
            logActivity('field_add', newField.id, `Added new field: ${name}`);
            
            // Reset form and update UI
            document.getElementById('fieldForm').reset();
            updateUI();
        }

        // Save a new crop
        function saveCrop() {
            const fieldId = parseInt(document.getElementById('cropField').value);
            const type = document.getElementById('cropType').value;
            const plantingDate = document.getElementById('plantingDate').value;
            const harvestDate = document.getElementById('harvestDate').value;
            const variety = document.getElementById('cropVariety').value;
            const density = parseInt(document.getElementById('cropDensity').value) || 0;
            const notes = document.getElementById('cropNotes').value;
            
            const newCrop = {
                id: crops.length > 0 ? Math.max(...crops.map(c => c.id)) + 1 : 1,
                fieldId,
                type,
                plantingDate,
                harvestDate,
                variety,
                density,
                notes,
                status: 'growing',
                createdAt: new Date().toISOString()
            };
            
            crops.push(newCrop);
            localStorage.setItem('crops', JSON.stringify(crops));
            
            // Log activity
            const field = fields.find(f => f.id === fieldId);
            logActivity('planting', fieldId, `Planted ${type} in ${field?.name || 'field'}`, newCrop.id);
            
            // Reset form and update UI
            document.getElementById('cropForm').reset();
            updateUI();
        }

        // Save a soil test
        function saveSoilTest() {
            const fieldId = parseInt(document.getElementById('soilField').value);
            const date = document.getElementById('testDate').value;
            const ph = parseFloat(document.getElementById('phLevel').value);
            const organicMatter = parseFloat(document.getElementById('organicMatter').value) || 0;
            const nitrogen = parseInt(document.getElementById('nitrogen').value) || 0;
            const phosphorus = parseInt(document.getElementById('phosphorus').value) || 0;
            const potassium = parseInt(document.getElementById('potassium').value) || 0;
            const notes = document.getElementById('soilNotes').value;
            
            const newTest = {
                id: soilTests.length > 0 ? Math.max(...soilTests.map(t => t.id)) + 1 : 1,
                fieldId,
                date,
                ph,
                organicMatter,
                nitrogen,
                phosphorus,
                potassium,
                notes,
                createdAt: new Date().toISOString()
            };
            
            soilTests.push(newTest);
            localStorage.setItem('soilTests', JSON.stringify(soilTests));
            
            // Log activity
            const field = fields.find(f => f.id === fieldId);
            logActivity('soil_test', fieldId, `Conducted soil test in ${field?.name || 'field'}`);
            
            // Reset form and update UI
            document.getElementById('soilTestForm').reset();
            updateUI();
        }

        // Log an activity
        function logActivity(type, fieldId, notes, cropId = null) {
            const newActivity = {
                id: activities.length > 0 ? Math.max(...activities.map(a => a.id)) + 1 : 1,
                type,
                fieldId,
                cropId,
                date: new Date().toISOString().split('T')[0],
                notes,
                createdAt: new Date().toISOString()
            };
            
            activities.push(newActivity);
            localStorage.setItem('activities', JSON.stringify(activities));
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        // Edit a field
        function editField(fieldId) {
            const field = fields.find(f => f.id === fieldId);
            if (!field) return;
            
            document.getElementById('fieldName').value = field.name;
            document.getElementById('fieldSize').value = field.size;
            document.getElementById('fieldType').value = field.type;
            document.getElementById('fieldLocation').value = field.location || '';
            document.getElementById('fieldNotes').value = field.notes || '';
            
            // Remove from fields array
            fields = fields.filter(f => f.id !== fieldId);
            localStorage.setItem('fields', JSON.stringify(fields));
            
            // Scroll to form
            document.getElementById('fieldForm').scrollIntoView();
        }

        // Delete a field
        function deleteField(fieldId) {
            if (!confirm('Are you sure you want to delete this field?')) return;
            
            fields = fields.filter(f => f.id !== fieldId);
            localStorage.setItem('fields', JSON.stringify(fields));
            
            // Also remove any crops in this field
            crops = crops.filter(c => c.fieldId !== fieldId);
            localStorage.setItem('crops', JSON.stringify(crops));
            
            updateUI();
        }

        // Edit a crop
        function editCrop(cropId) {
            const crop = crops.find(c => c.id === cropId);
            if (!crop) return;
            
            document.getElementById('cropField').value = crop.fieldId;
            document.getElementById('cropType').value = crop.type;
            document.getElementById('plantingDate').value = crop.plantingDate;
            document.getElementById('harvestDate').value = crop.harvestDate;
            document.getElementById('cropVariety').value = crop.variety || '';
            document.getElementById('cropDensity').value = crop.density || '';
            document.getElementById('cropNotes').value = crop.notes || '';
            
            // Remove from crops array
            crops = crops.filter(c => c.id !== cropId);
            localStorage.setItem('crops', JSON.stringify(crops));
            
            // Scroll to form
            document.getElementById('cropForm').scrollIntoView();
        }

        // Delete a crop
        function deleteCrop(cropId) {
            if (!confirm('Are you sure you want to delete this crop?')) return;
            
            crops = crops.filter(c => c.id !== cropId);
            localStorage.setItem('crops', JSON.stringify(crops));
            
            updateUI();
        }

        // View soil test details
        function viewSoilTest(testId) {
            const test = soilTests.find(t => t.id === testId);
            if (!test) return;
            
            alert(`Soil Test Details:\n\nField: ${fields.find(f => f.id === test.fieldId)?.name || 'Unknown'}\nDate: ${formatDate(test.date)}\npH: ${test.ph}\nN-P-K: ${test.nitrogen}-${test.phosphorus}-${test.potassium}\nOrganic Matter: ${test.organicMatter}%\nNotes: ${test.notes || 'None'}`);
        }

        // Delete soil test
        function deleteSoilTest(testId) {
            if (!confirm('Are you sure you want to delete this soil test?')) return;
            
            soilTests = soilTests.filter(t => t.id !== testId);
            localStorage.setItem('soilTests', JSON.stringify(soilTests));
            
            updateUI();
        }
    </script>
</body>
</html>